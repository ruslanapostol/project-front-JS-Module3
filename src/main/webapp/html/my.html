<!DOCTYPE html>
<html lang="en">
<head>
    <title>RPG</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="/css/my.css" rel="stylesheet">
</head>
<body>
<h1>RPG admin panel</h1>

<table id="rpgTable">
<thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>
    </tr>
</thead>

    <tbody>
    <!-- Player rows will go here -->
    </tbody>
</table>

<div id="accountDisplayContainer">
    <label for="accountCountDropdown">Accounts to display:</label>
    <select id="accountCountDropdown">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
    </select>
</div>

<!-- Paging buttons section -->
<div id="pagingButtons">
    <button>Prev</button>
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button>4</button>
    <button>5</button>
    <button>Next</button>
</div>


<hr> <!-- Horizontal line -->
<div id="newAccountSection">
    <h3>Create a New Account:</h3>
    <label for="newName">Name (1-12 characters):</label>
    <input type="text" id="newName" maxlength="12" required><br>

    <label for="newTitle">Title (1-30 characters):</label>
    <input type="text" id="newTitle" maxlength="30" required><br>

    <label for="newRace">Race:</label>
    <select id="newRace">
        <option value="Human">Human</option>
        <option value="Elf">Elf</option>
        <option value="Dwarf">Dwarf</option>
        <option value="Troll">Troll</option>
        <option value="Giant">Giant</option>
        <option value="Hobbit">Hobbit</option>
        <option value="Orc">Orc</option>

    </select><br>

    <label for="newProfession">Profession:</label>
    <select id="newProfession">
        <option value="Warrior">Warrior</option>
        <option value="Mage">Mage</option>
        <option value="Archer">Archer</option>
        <option value="Sorcerer">Sorcerer</option>
        <option value="Cleric">Cleric</option>
        <option value="Paladin">Paladin</option>
        <option value="Nazgul">Nazgul</option>
        <option value="Druid">Druid</option>
        <option value="Rogue">Rogue</option>

    </select><br>

    <label for="newLevel">Level (0-100):</label>
    <input type="number" id="newLevel" min="0" max="100" required><br>

    <label for="newBirthday">Birthday:</label>
    <input type="date" id="newBirthday" required><br>

    <label for="newBanned">Banned:</label>
    <input type="checkbox" id="newBanned"><br>

    <button onclick="submitNewAccount()">Save</button>
</div>

<script>
    let currentPage = 1;
    let accountsPerPage = parseInt(document.getElementById('accountCountDropdown').value, 10);

    function fetchPlayers(pageNumber, pageSize) {
        const url = `/rest/players?pageNumber=${pageNumber}&pageSize=${pageSize}`;
        fetch(url)
            .then(response => response.json())
            .then(players => {
                const tableBody = document.getElementById('rpgTable').getElementsByTagName('tbody')[0];
                let rowsHTML = ''; // Initialize an empty string to hold all the rows HTML

                players.forEach((player, index) => {
                    // Create the row HTML as a string
                    const rowHTML = `<tr>
                    <td>${((pageNumber - 1) * pageSize) + index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.title}</td>
                    <td>${player.race}</td>
                    <td>${player.profession}</td>
                    <td>${player.level}</td>
                    <td>${new Date(player.birthday).toLocaleDateString()}</td>
                    <td>${player.banned ? 'Yes' : 'No'}</td>
                    <td><img src="/img/colored_edit.jpg" alt="Edit" class="action-icon" onclick="editPlayer(${player.id})"></td>
                    <td><img src="/img/colored_delete.jpg" alt="Delete" class="action-icon" onclick="deleteAccount(${player.id})"></td>
                </tr>`;

                    rowsHTML += rowHTML; // Append the row's HTML to the rowsHTML string
                });

                tableBody.innerHTML = rowsHTML; // Set the table body's HTML to the rowsHTML string in one operation
            })
            .catch(error => console.error('Error fetching players:', error));
    }


    function submitNewAccount() {
        const name = document.getElementById('newName').value;
        const title = document.getElementById('newTitle').value;
        // Add more validations as needed
        if (name.length < 1 || name.length > 12) {
            alert('Name must be between 1 and 12 characters');
            return;
        }
        if (title.length < 1 || title.length > 30) {
            alert('Title must be between 1 and 30 characters');
            return;
        }

        const birthday = new Date(document.getElementById('newBirthday').value).getTime();
        const newAccountData = {
            name: document.getElementById('newName').value,
            title: document.getElementById('newTitle').value,
            race: document.getElementById('newRace').value,
            profession: document.getElementById('newProfession').value,
            level: parseInt(document.getElementById('newLevel').value, 10),
            birthday: birthday,
            banned: document.getElementById('newBanned').checked
        };

        // Send the data to the server
        fetch('/rest/players', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(newAccountData)
        })
            .then(response => {
                if (response.ok) {
                    return response.json(); // or `return;` if your API doesn't send back any content
                } else {
                    throw new Error('Failed to create account');
                }
            })
            .then(() => {
                // Clear input fields
                document.getElementById('newName').value = '';
                document.getElementById('newTitle').value = '';
                document.getElementById('newRace').selectedIndex = 0;
                document.getElementById('newProfession').selectedIndex = 0;
                document.getElementById('newLevel').value = '';
                document.getElementById('newBirthday').value = '';
                document.getElementById('newBanned').checked = false;

                // Refresh the list of accounts
                fetchPlayers(currentPage, accountsPerPage);
            })
            .catch(error => {
                console.error('Error creating new account:', error);
                alert(error.message); // Show error message to user
            });
    }


    function deleteAccount(accountId) {
        if (confirm('Are you sure you want to delete this account?')) { // Confirm deletion with the user
            fetch(`/rest/players/${accountId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Account deleted successfully.');
                        fetchPlayers(currentPage, accountsPerPage); // Refresh the list of accounts
                    } else {
                        alert('There was an error deleting the account.');
                    }
                })
                .catch(error => console.error('Error deleting account:', error));
        }
    }

    let totalAccounts = 0;

    function fetchTotalAccountsAndUpdatePages() {
        fetch('/rest/players/count')
            .then(response => response.json())
            .then(totalCount => {
                totalAccounts = totalCount;
                updateTotalPages();
            })
            .catch(error => console.error('Error fetching total accounts:', error));
    }

    function updateTotalPages() {
        const totalPages = Math.ceil(totalAccounts / accountsPerPage);
        const pagingButtons = document.getElementById('pagingButtons');
        pagingButtons.innerHTML = '';

        const prevButton = document.createElement('button');
        prevButton.innerText = 'Prev';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                fetchPlayers(currentPage, accountsPerPage);
            }
        };
        pagingButtons.appendChild(prevButton);


        for (let page = 1; page <= totalPages; page++) {
            const button = document.createElement('button');
            button.innerText = page.toString();
            button.onclick = () => {
                currentPage = page;
                fetchPlayers(currentPage, accountsPerPage);
            };

            button.className = page === currentPage ? 'active' : '';
            pagingButtons.appendChild(button);
        }

        const nextButton = document.createElement('button');
        nextButton.innerText = 'Next';
        nextButton.disabled = currentPage === totalPages;
        nextButton.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchPlayers(currentPage, accountsPerPage);
            }
        };
        pagingButtons.appendChild(nextButton);

    }


    document.getElementById('accountCountDropdown').addEventListener('change', function () {
        accountsPerPage = parseInt(this.value, 10);
        fetchTotalAccountsAndUpdatePages();
        fetchPlayers(currentPage, accountsPerPage);
    });

    function editPlayer(playerId) {
        const table = document.getElementById('rpgTable');
        const rows = table.getElementsByTagName('tbody')[0].rows;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const rowPlayerId = row.getAttribute('data-player-id');


            if (rowPlayerId === playerId) {
                const editCell = row.cells[8]; // Assuming the edit icon is in the 9th cell
                const deleteCell = row.cells[9]; // Assuming the delete icon is in the 10th cell

                // Determine whether we're currently in edit mode based on the presence of input fields
                const isInEditMode = row.querySelector('input') !== null;

                if (!isInEditMode) {
                    // Entering edit mode
                    enterEditMode(row);
                    // Change the edit icon to a save icon
                    editCell.children[0].src = '/img/colored_save.jpg';
                    // Hide the delete button
                    deleteCell.style.display = 'none';
                } else {
                    // Exiting edit mode, collect data to update
                    const updatedData = exitEditMode(row);

                    // Send POST request to server to save the updated data
                    fetch(`/rest/players/${playerId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedData)
                    })
                        .then(response => {
                            if (response.ok) {
                                // If the update was successful, refresh the data displayed
                                fetchPlayers(currentPage, accountsPerPage);
                                alert('Player updated successfully.');
                            } else {
                                // If there was an issue with the update
                                alert('Failed to update player.');
                            }
                        })
                        .catch(error => {
                            console.error('Error updating player:', error);
                            alert('Error updating player.');
                        });

                    // Change the save icon back to an edit icon
                    editCell.children[0].src = '/img/colored_edit.jpg';
                    // Show the delete button again
                    deleteCell.style.display = '';
                }
                break; // Exit the loop after finding and handling the correct row
            }
        }
    }

    function enterEditMode(row) {
        for (let j = 1; j < row.cells.length - 2; j++) {  // Skip first and last two cells (ID, edit, delete)
            const cell = row.cells[j];
            const input = document.createElement('input');
            input.type = 'text';
            input.value = cell.innerText;
            cell.innerText = '';  // Clear existing text
            cell.appendChild(input);  // Add input field
        }
    }

    function exitEditMode(row) {
        // Object to store the updated player data
        const updatedData = {};

        // Extract and revert the 'Name' field
        const nameInput = row.cells[1].children[0];
        updatedData.name = nameInput.value;
        row.cells[1].innerText = nameInput.value;

        // Extract and revert the 'Title' field
        const titleInput = row.cells[2].children[0];
        updatedData.title = titleInput.value;
        row.cells[2].innerText = titleInput.value;

        // Extract and revert the 'Race' field
        const raceInput = row.cells[3].children[0];
        updatedData.race = raceInput.value;
        row.cells[3].innerText = raceInput.value;

        // Extract and revert the 'Profession' field
        const professionInput = row.cells[4].children[0];
        updatedData.profession = professionInput.value;
        row.cells[4].innerText = professionInput.value;

        // Extract and revert the 'Level' field
        const levelInput = row.cells[5].children[0];
        updatedData.level = parseInt(levelInput.value, 10); // Ensure this is an integer
        row.cells[5].innerText = levelInput.value;

        // Extract and revert the 'Birthday' field (assuming date is in 'YYYY-MM-DD' format)
        const birthdayInput = row.cells[6].children[0];
        updatedData.birthday = birthdayInput.value; // Keep as string or convert to timestamp as needed
        // Adjust how you convert/display the birthday if necessary
        row.cells[6].innerText = new Date(birthdayInput.value).toLocaleDateString();

        // Extract and revert the 'Banned' field
        const bannedInput = row.cells[7].children[0];
        updatedData.banned = bannedInput.checked; // Assuming this is a checkbox
        row.cells[7].innerText = bannedInput.checked ? 'Yes' : 'No';

        return updatedData; // Return the compiled data for the updated player
    }


    document.addEventListener('DOMContentLoaded', (event) => {
        currentPage = 1;
        accountsPerPage = parseInt(document.getElementById('accountCountDropdown').value, 10);
        fetchPlayers(currentPage, accountsPerPage);
        fetchTotalAccountsAndUpdatePages();

        document.getElementById('accountCountDropdown').addEventListener('change', function () {
            accountsPerPage = parseInt(this.value, 10);
            currentPage = 1; // Reset to first page since the page size has changed
            fetchTotalAccountsAndUpdatePages();
            fetchPlayers(currentPage, accountsPerPage);
        });
    });

</script>

</body>
</html>