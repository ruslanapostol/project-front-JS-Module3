<!DOCTYPE html>
<html lang="en">
<head>
    <title>RPG</title>
    <script src=https://code.jquery.com/jquery-3.6.0.min.js></script>
    <link href="/css/my.css" rel="stylesheet">
</head>
<body>
<h1>RPG admin panel</h1>
<table id="rpgTable">
    <thead>
    <tr>
        <th>#</th>
        <th>Name</th>
        <th>Title</th>
        <th>Race</th>
        <th>Profession</th>
        <th>Level</th>
        <th>Birthday</th>
        <th>Banned</th>
        <th>Edit</th>
        <th>Delete</th>

    </tr>
    </thead>
    <tbody>
    <!-- Data rows will go here -->
    </tbody>
</table>

<div id="accountDisplayOptions">
    <label for="accountCountDropdown">Accounts to display:</label>
    <select id="accountCountDropdown">
        <option value="3">3</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="20">20</option>
    </select>
</div>

<!-- Paging buttons section -->
<div id="pagingButtons">
    <button>Prev</button>
    <button>1</button>
    <button>2</button>
    <button>3</button>
    <button>4</button>
    <button>5</button>
    <button>Next</button>
</div>
<script>
    let currentPage = 1;
    let accountsPerPage = parseInt(document.getElementById('accountCountDropdown').value, 10);

    function fetchPlayers(pageNumber, pageSize) {
        const url = `/rest/players?pageNumber=${pageNumber}&pageSize=${pageSize}`;
        fetch(url)
            .then(response => response.json())
            .then(players => {
                const table = document.getElementById('rpgTable').getElementsByTagName('tbody')[0];
                table.innerHTML = ""; // Clear the table body before adding new rows
                players.forEach((player, index) => {
                    const row = table.insertRow();
                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    const cell3 = row.insertCell(2);
                    const cell4 = row.insertCell(3);
                    const cell5 = row.insertCell(4);
                    const cell6 = row.insertCell(5);
                    const cell7 = row.insertCell(6);
                    const cell8 = row.insertCell(7);
                    const editCell = row.insertCell(8);
                    const deleteCell = row.insertCell(9);

                    cell1.innerHTML = ((pageNumber - 1) * pageSize) + index + 1;
                    cell2.innerHTML = player.name;
                    cell3.innerHTML = player.title;
                    cell4.innerHTML = player.race;
                    cell5.innerHTML = player.profession;
                    cell6.innerHTML = player.level;
                    cell7.innerHTML = new Date(player.birthday).toLocaleDateString();
                    cell8.innerHTML = player.banned ? 'Yes' : 'No';

                    // Edit icon
                    const editIcon = document.createElement('img');
                    editIcon.src = '/img/colored_edit.jpg';
                    editIcon.alt = 'Edit';
                    editIcon.className = 'action-icon';
                    editIcon.addEventListener('click', () => editPlayer(player.id));
                    editCell.appendChild(editIcon);

                    // Delete icon
                    const deleteIcon = document.createElement('img');
                    deleteIcon.src = '/img/colored_delete.jpg';
                    deleteIcon.alt = 'Delete';
                    deleteIcon.className = 'action-icon';
                    deleteIcon.addEventListener('click', () => deleteAccount(player.id));
                    deleteCell.appendChild(deleteIcon);
                });
            })
            .catch(error => console.error('Error fetching players:', error));
    }

    function deleteAccount(accountId) {
        if (confirm('Are you sure you want to delete this account?')) { // Confirm deletion with the user
            fetch(`/rest/players/${accountId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        alert('Account deleted successfully.');
                        fetchPlayers(currentPage, accountsPerPage); // Refresh the list of accounts
                    } else {
                        alert('There was an error deleting the account.');
                    }
                })
                .catch(error => console.error('Error deleting account:', error));
        }
    }


    // Function to fetch the total number of players/accounts and update page count
    function fetchTotalAccountsAndUpdatePages() {
        fetch('/rest/players/count')
            .then(response => response.json())
            .then(totalCount => {
                totalAccounts = totalCount;
                updateTotalPages();
            })
            .catch(error => console.error('Error fetching total accounts:', error));
    }

    function updateTotalPages() {
        const totalPages = Math.ceil(totalAccounts / accountsPerPage);
        const pagingButtons = document.getElementById('pagingButtons');
        // Clear existing buttons before adding new ones
        pagingButtons.innerHTML = '';

        const prevButton = document.createElement('button');
        prevButton.innerText = 'Prev';
        prevButton.disabled = currentPage === 1;
        prevButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                fetchPlayers(currentPage, accountsPerPage);
            }
        });
        pagingButtons.appendChild(prevButton);


        for (let page = 1; page <= totalPages; page++) {
            const button = document.createElement('button');
            button.innerText = page;
            button.addEventListener('click', function () {
                currentPage = page;
                fetchPlayers(currentPage, accountsPerPage);
            });


            if (page === currentPage) {
                button.className = 'active';
            }

            pagingButtons.appendChild(button);
        }

        const nextButton = document.createElement('button');
        nextButton.innerText = 'Next';
        nextButton.disabled = currentPage === totalPages;
        nextButton.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                fetchPlayers(currentPage, accountsPerPage);
            }
        });
        pagingButtons.appendChild(nextButton);

        console.log('Total pages:', totalPages);
    }


    document.getElementById('accountCountDropdown').addEventListener('change', function () {
        accountsPerPage = parseInt(this.value, 10);
        fetchTotalAccountsAndUpdatePages();
        fetchPlayers(currentPage, accountsPerPage);
    });

    function editPlayer(playerId) {
        const table = document.getElementById('rpgTable');
        const rows = table.getElementsByTagName('tbody')[0].rows;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if (row.cells[0].innerText === ((currentPage - 1) * accountsPerPage + i + 1).toString()) {
                const editCell = row.cells[8];
                const deleteCell = row.cells[9];

                if (editCell.children[0].getAttribute('src').includes('edit')) {
                    for (let j = 0; j <= 5 ; j++) {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = row.cells[j].innerText;
                        row.cells[j].innerText = '';
                        row.cells[j].appendChild(input);
                    }

                    deleteCell.style.display = 'none';
                    editCell.children[0].src = '/img/colored_save.jpg';
                } else {
                    const updatedData = {
                        name: row.cells[1].children[0].value,
                        title: row.cells[2].children[0].value,
                        race: row.cells[3].children[0].value,
                        profession: row.cells[4].children[0].value,
                        banned: row.cells[5].children[0].value
                    };

                    // Send POST request to server to save the updated data
                    fetch(`/rest/players/${playerId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(updatedData)
                    })
                        .then(response => {
                            if (response.ok) {
                                // Success feedback
                                alert('Player updated successfully.');
                                fetchPlayers(currentPage, accountsPerPage);
                            } else {
                                alert('Failed to update player.');
                                response.json().then(data => console.log(data));
                            }
                        })
                        .catch(error => {
                            console.error('Error updating player:', error);
                            alert('Error updating player.');
                        });

                    
                    deleteCell.style.display = '';
                    editCell.children[0].src = '/img/colored_edit.jpg';

                }
                break;
            }
        }
    }

    window.onload = function () {
        fetchPlayers(currentPage, accountsPerPage);
        fetchTotalAccountsAndUpdatePages();
    };
</script>

</body>
</html>